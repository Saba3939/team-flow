# team-flow - 統合チーム開発CLIツール仕様書

## 📋 概要

**team-flow**は、Git/GitHub初心者でも使いやすい対話型ガイド機能とワークフロー簡素化機能を組み合わせた統合チーム開発CLIツールです。チーム連携特化機能により、効率的な共同開発を実現します。

### 🚀 主要機能
- **対話型ガイド**: 初心者にも分かりやすいメニュー形式
- **ワークフロー簡素化**: 複雑なGitコマンドを自動化  
- **チーム連携**: Slack/Discord通知、競合検知、レビュー支援
- **安全機能**: 操作前確認、自動バックアップ

## 🏗️ アーキテクチャ

### 技術スタック
- **CLI Framework**: Commander.js - 柔軟なコマンドライン作成
- **対話型UI**: Inquirer.js - 美しいプロンプト・選択肢
- **API連携**: 
  - GitHub API: @octokit/rest - リポジトリ・Issue・PR管理
  - Slack API: @slack/web-api - チーム通知
  - Discord Webhook: discord-webhook-node - チャンネル通知
- **設定管理**: dotenv - 環境変数・認証情報
- **ファイル操作**: fs-extra - ファイルシステム拡張

### プロジェクト構造
```
team-flow/
├── package.json
├── .env.example
├── .gitignore
├── README.md
├── bin/
│   └── team-flow.js         # エントリーポイント
├── src/
│   ├── index.js             # メインプログラム
│   ├── config/
│   │   ├── constants.js     # 定数定義
│   │   └── env.js           # 環境変数設定
│   ├── commands/
│   │   ├── start.js         # 新規作業開始
│   │   ├── continue.js      # 作業継続
│   │   ├── finish.js        # 作業完了
│   │   ├── team.js          # チーム状況確認
│   │   └── help.js          # ヘルプ・緊急対応
│   ├── services/
│   │   ├── git.js           # Git操作
│   │   ├── github.js        # GitHub API
│   │   ├── slack.js         # Slack通知
│   │   ├── discord.js       # Discord通知
│   │   └── conflict.js      # 競合検知
│   ├── utils/
│   │   ├── prompts.js       # 対話型プロンプト
│   │   ├── validation.js    # 入力検証
│   │   ├── logger.js        # ログ管理
│   │   └── helpers.js       # 共通ヘルパー
│   └── templates/
│       ├── commit.js        # コミットメッセージテンプレート
│       └── pr.js            # PRテンプレート
└── tests/
    ├── unit/                # ユニットテスト
    └── integration/         # 統合テスト
```

## 🔧 詳細機能仕様

### 1. 新しい作業を始める (`team-flow start`)

#### フロー
1. **作業種別選択**
   ```
   ? 今日は何をしますか？
   ❯ 新しい機能開発
     バグ修正 
     ドキュメント更新
     リファクタリング
     緊急対応
   ```

2. **Issue連携**
   ```javascript
   // GitHub Issues取得・表示
   const issues = await github.rest.issues.listForRepo({
     owner,
     repo,
     state: 'open',
     assignee: username
   });
   ```

3. **自動ブランチ作成**
   ```bash
   # 命名規則: feature/issue-123-description
   git checkout -b feature/issue-123-add-login-form
   ```

4. **競合チェック**
   ```javascript
   // 同じファイルを編集中のメンバー検知
   const conflictRisk = await checkFileConflicts(changedFiles);
   if (conflictRisk.length > 0) {
     console.warn(`⚠️  注意: ${conflictRisk.join(', ')}が同じファイルを編集中です`);
   }
   ```

5. **チーム通知**
   ```javascript
   // Slack/Discord通知
   await notifyTeam({
     message: `🚀 ${username}が${issueTitle}の作業を開始しました`,
     channel: 'development',
     thread: issueNumber
   });
   ```

### 2. 作業を継続する (`team-flow continue`)

#### フロー
1. **現在の状況表示**
   ```
   📋 現在のブランチ: feature/issue-123-add-login-form
   📝 未コミット変更: 3ファイル
   🔄 リモート変更: 2コミット先行
   ⚠️  競合の可能性: UserService.js (田中さんも編集中)
   ```

2. **推奨アクション提案**
   ```
   ? 次にすることをお選びください
   ❯ 変更をコミットする
     リモートの変更を取り込む (git pull)
     田中さんに連絡を取る (競合回避)
     作業を一時保存する (git stash)
   ```

3. **自動同期機能**
   ```javascript
   // 定期的なリモート変更チェック
   const remoteDiff = await checkRemoteChanges(currentBranch);
   if (remoteDiff.behindBy > 0) {
     const shouldPull = await confirm('リモートに新しい変更があります。取り込みますか？');
     if (shouldPull) await gitPull();
   }
   ```

### 3. 作業を完了する (`team-flow finish`)

#### フロー
1. **コミット支援**
   ```javascript
   // 対話型コミットメッセージ作成
   const commitType = await select({
     message: 'コミットの種類は？',
     choices: [
       { name: '✨ feat: 新機能', value: 'feat' },
       { name: '🐛 fix: バグ修正', value: 'fix' },
       { name: '📚 docs: ドキュメント', value: 'docs' },
       { name: '💎 style: コードフォーマット', value: 'style' },
       { name: '♻️  refactor: リファクタリング', value: 'refactor' }
     ]
   });
   ```

2. **自動テスト実行**
   ```javascript
   const shouldRunTests = await confirm('テストを実行しますか？');
   if (shouldRunTests) {
     spinner.start('テスト実行中...');
     const testResult = await exec('npm test');
     if (testResult.code !== 0) {
       console.error('❌ テストが失敗しました。修正してから続行してください。');
       return;
     }
   }
   ```

3. **PR作成・レビュアー提案**
   ```javascript
   // PR作成とレビュアー自動提案
   const reviewers = await suggestReviewers(changedFiles, teamMembers);
   const pr = await github.rest.pulls.create({
     title: generatePRTitle(commitMessages),
     body: generatePRBody(issueNumber, changes),
     reviewers: reviewers.map(r => r.username)
   });
   ```

4. **完了通知**
   ```javascript
   await notifyTeam({
     message: `🎉 ${username}が${issueTitle}のPRを作成しました`,
     link: pr.html_url,
     reviewers: reviewers
   });
   ```

### 4. チーム状況確認 (`team-flow team`)

#### 表示内容
```
👥 チーム作業状況 (更新: 2025-09-22 14:30)

📊 アクティブブランチ:
├── feature/issue-123-login    佐藤さん   (2時間前〜)
├── fix/issue-124-validation   田中さん   (30分前〜) 
└── docs/readme-update         鈴木さん   (1日前〜)

🔍 レビュー待ち:
├── PR #45: 新規登録機能      → 田中さん、山田さん
└── PR #46: エラーハンドリング → 佐藤さん

⚠️  競合警告:
└── UserController.js (佐藤さん・田中さん)

📈 今日の活動:
├── コミット: 12件
├── PR作成: 3件
└── マージ: 2件
```

#### 技術実装
```javascript
// 並行作業検知
async function detectConflicts() {
  const activeBranches = await getActiveBranches();
  const conflicts = [];
  
  for (const branch of activeBranches) {
    const changedFiles = await getChangedFiles(branch);
    const overlaps = findFileOverlaps(changedFiles, activeBranches);
    if (overlaps.length > 0) conflicts.push(...overlaps);
  }
  
  return conflicts;
}
```

### 5. ヘルプ・緊急対応 (`team-flow help`)

#### 緊急時対応フロー
```
? 何にお困りですか？
❯ コミットを取り消したい
  間違ったファイルを追加してしまった
  マージでコンフリクトが発生した
  プッシュに失敗した
  ブランチを切り替えたい
  初心者向けガイドを見たい
```

#### 自動復旧機能
```javascript
// 安全な操作復旧
async function handleEmergency(situation) {
  switch (situation) {
    case 'wrong-commit':
      return await safeReset();
    case 'merge-conflict':
      return await guideConflictResolution();
    case 'push-failed':
      return await diagnosePushIssue();
  }
}
```

## 🔌 API統合仕様

### GitHub API連携
```javascript
// @octokit/rest使用例
import { Octokit } from '@octokit/rest';

class GitHubService {
  constructor() {
    this.octokit = new Octokit({
      auth: process.env.GITHUB_TOKEN
    });
  }
  
  async createPR(title, body, base, head) {
    return await this.octokit.rest.pulls.create({
      owner: process.env.GITHUB_OWNER,
      repo: process.env.GITHUB_REPO,
      title,
      body, 
      base,
      head
    });
  }
  
  async getIssues(assignee) {
    return await this.octokit.rest.issues.listForRepo({
      owner: process.env.GITHUB_OWNER,
      repo: process.env.GITHUB_REPO,
      assignee,
      state: 'open'
    });
  }
}
```

### Slack API連携
```javascript
// @slack/web-api使用例
import { WebClient } from '@slack/web-api';

class SlackService {
  constructor() {
    this.client = new WebClient(process.env.SLACK_TOKEN);
  }
  
  async notifyChannel(channel, message, thread_ts) {
    return await this.client.chat.postMessage({
      channel,
      text: message,
      thread_ts,
      unfurl_links: false
    });
  }
  
  async notifyUser(userId, message) {
    const dm = await this.client.conversations.open({
      users: userId
    });
    
    return await this.client.chat.postMessage({
      channel: dm.channel.id,
      text: message
    });
  }
}
```

### Discord Webhook連携
```javascript
// discord-webhook-node使用例
import { Webhook } from 'discord-webhook-node';

class DiscordService {
  constructor() {
    this.hook = new Webhook(process.env.DISCORD_WEBHOOK_URL);
    this.hook.setUsername('Team Flow Bot');
  }
  
  async notify(message, embeds = []) {
    return await this.hook.send({
      content: message,
      embeds
    });
  }
  
  async notifyPR(prData) {
    const embed = {
      title: `📋 新しいPR: ${prData.title}`,
      url: prData.html_url,
      color: 0x00ff00,
      fields: [
        { name: '作成者', value: prData.author, inline: true },
        { name: 'ブランチ', value: prData.head.ref, inline: true }
      ]
    };
    
    return await this.notify('', [embed]);
  }
}
```

## ⚙️ 設定・環境変数

### .env.example
```bash
# GitHub設定
GITHUB_TOKEN=ghp_xxxxxxxxxxxxxxxxxxxx
GITHUB_OWNER=your-organization
GITHUB_REPO=your-repository

# Slack設定 (オプション)
SLACK_TOKEN=xoxb-xxxxxxxxxxxx
SLACK_CHANNEL_DEV=#development
SLACK_CHANNEL_GENERAL=#general

# Discord設定 (オプション)  
DISCORD_WEBHOOK_URL=https://discord.com/api/webhooks/xxxxx/xxxxx

# チーム設定
TEAM_MEMBERS=alice,bob,charlie
DEFAULT_REVIEWERS=alice,bob

# 通知設定
ENABLE_SLACK_NOTIFICATIONS=true
ENABLE_DISCORD_NOTIFICATIONS=false
ENABLE_CONFLICT_DETECTION=true

# Git設定
DEFAULT_BRANCH=main
BRANCH_PREFIX=feature/
AUTO_FETCH_INTERVAL=300000

# テスト設定
RUN_TESTS_ON_FINISH=true
TEST_COMMAND=npm test
```

### package.json
```json
{
  "name": "team-flow",
  "version": "1.0.0",
  "description": "統合チーム開発CLIツール",
  "main": "src/index.js",
  "bin": {
    "team-flow": "bin/team-flow.js"
  },
  "scripts": {
    "start": "node src/index.js",
    "test": "jest",
    "dev": "nodemon src/index.js",
    "build": "pkg . --out-path dist"
  },
  "dependencies": {
    "commander": "^11.0.0",
    "@inquirer/prompts": "^3.0.0", 
    "@octokit/rest": "^20.0.0",
    "@slack/web-api": "^6.0.0",
    "discord-webhook-node": "^1.0.0",
    "dotenv": "^16.0.0",
    "fs-extra": "^11.0.0",
    "chalk": "^5.0.0",
    "ora": "^7.0.0",
    "simple-git": "^3.0.0"
  },
  "devDependencies": {
    "jest": "^29.0.0",
    "nodemon": "^3.0.0",
    "@types/node": "^20.0.0"
  },
  "keywords": [
    "cli", 
    "git", 
    "github", 
    "team", 
    "workflow"
  ],
  "author": "Your Name",
  "license": "MIT"
}
```

## 📦 インストール・セットアップ

### 1. プロジェクト初期化
```bash
# プロジェクト作成
mkdir team-flow
cd team-flow
npm init -y

# 依存関係インストール
npm install commander @inquirer/prompts @octokit/rest @slack/web-api discord-webhook-node dotenv fs-extra chalk ora simple-git

# 開発依存関係
npm install -D jest nodemon @types/node
```

### 2. 認証設定
```bash
# .envファイル作成
cp .env.example .env

# GitHub Personal Access Token設定
# Settings > Developer settings > Personal access tokens > Generate new token
# 必要な権限: repo, read:org, write:discussion

# Slack Bot Token取得 (オプション)
# https://api.slack.com/apps > Create New App
# OAuth & Permissions > Scopes: chat:write, channels:read

# Discord Webhook URL取得 (オプション)  
# サーバー設定 > 連携サービス > ウェブフック > 新しいウェブフック
```

### 3. 初回実行
```bash
# グローバルインストール (推奨)
npm install -g .

# 初回設定
team-flow --init

# 使用開始
team-flow
```

## 🔧 コア実装例

### メインエントリーポイント (src/index.js)
```javascript
#!/usr/bin/env node

import { Command } from 'commander';
import { input, select, confirm } from '@inquirer/prompts';
import chalk from 'chalk';
import 'dotenv/config';

import startCommand from './commands/start.js';
import continueCommand from './commands/continue.js';
import finishCommand from './commands/finish.js';
import teamCommand from './commands/team.js';
import helpCommand from './commands/help.js';

const program = new Command();

program
  .name('team-flow')
  .description('統合チーム開発CLIツール')
  .version('1.0.0');

// メインメニュー
async function showMainMenu() {
  console.log(chalk.blue.bold('\n🚀 Team Flow - チーム開発を効率化\n'));
  
  const action = await select({
    message: '今日は何をしますか？',
    choices: [
      { name: '🆕 新しい作業を始める', value: 'start' },
      { name: '⏭️  作業を続ける', value: 'continue' },
      { name: '✅ 作業を完了する', value: 'finish' },
      { name: '👥 チーム状況を確認する', value: 'team' },
      { name: '🆘 ヘルプ・緊急対応', value: 'help' },
      { name: '🚪 終了', value: 'exit' }
    ]
  });

  switch (action) {
    case 'start':
      await startCommand();
      break;
    case 'continue':
      await continueCommand();
      break;
    case 'finish':
      await finishCommand();
      break;
    case 'team':
      await teamCommand();
      break;
    case 'help':
      await helpCommand();
      break;
    case 'exit':
      console.log(chalk.green('👋 お疲れさまでした！'));
      process.exit(0);
  }
  
  // メニューに戻る
  const shouldContinue = await confirm({ message: 'メニューに戻りますか？' });
  if (shouldContinue) {
    await showMainMenu();
  }
}

// コマンドライン引数がない場合はメニューを表示
if (process.argv.length === 2) {
  showMainMenu().catch(console.error);
} else {
  program.parse();
}
```

### 対話型プロンプト (src/utils/prompts.js)
```javascript
import { input, select, confirm, checkbox } from '@inquirer/prompts';
import chalk from 'chalk';

export async function selectWorkType() {
  return await select({
    message: '作業の種類を選択してください',
    choices: [
      { 
        name: '✨ 新機能開発', 
        value: 'feature',
        description: '新しい機能やコンポーネントの開発'
      },
      { 
        name: '🐛 バグ修正', 
        value: 'bugfix',
        description: '既存機能の不具合修正'
      },
      { 
        name: '📚 ドキュメント更新', 
        value: 'docs',
        description: 'README、コメント、ドキュメントの更新'
      },
      { 
        name: '♻️  リファクタリング', 
        value: 'refactor',
        description: 'コード品質向上・構造改善'
      },
      { 
        name: '🚨 緊急対応', 
        value: 'hotfix',
        description: '本番環境の緊急修正'
      }
    ]
  });
}

export async function selectCommitType() {
  return await select({
    message: 'コミットの種類を選択してください',
    choices: [
      { name: '✨ feat: 新機能', value: 'feat' },
      { name: '🐛 fix: バグ修正', value: 'fix' },
      { name: '📚 docs: ドキュメント', value: 'docs' },
      { name: '💎 style: スタイル・フォーマット', value: 'style' },
      { name: '♻️  refactor: リファクタリング', value: 'refactor' },
      { name: '⚡ perf: パフォーマンス改善', value: 'perf' },
      { name: '✅ test: テスト追加・修正', value: 'test' },
      { name: '🔧 chore: その他の変更', value: 'chore' }
    ]
  });
}

export async function getCommitMessage() {
  const description = await input({
    message: '変更内容を簡潔に説明してください',
    validate: (input) => {
      if (input.length < 10) return '10文字以上で入力してください';
      if (input.length > 72) return '72文字以下で入力してください';
      return true;
    }
  });
  
  return description;
}

export async function confirmAction(message, defaultValue = false) {
  return await confirm({
    message: chalk.yellow(`⚠️  ${message}`),
    default: defaultValue
  });
}
```

## 💻 使用例・ワークフロー

### 日常的な使用パターン

#### 朝の作業開始
```bash
$ team-flow

🚀 Team Flow - チーム開発を効率化

? 今日は何をしますか？
❯ 🆕 新しい作業を始める

? 作業の種類を選択してください
❯ ✨ 新機能開発

? 作業するIssueを選択してください
❯ #123: ユーザーログイン機能の実装
  #124: パスワードリセット機能  
  新しいIssueを作成

✅ ブランチ作成: feature/issue-123-user-login
✅ チームに通知送信
🚀 作業開始！ファイルの編集を始めてください
```

#### 作業中の確認
```bash
$ team-flow continue

📋 現在の状況:
- ブランチ: feature/issue-123-user-login
- 変更ファイル: src/auth/login.js, src/components/LoginForm.jsx
- 最終コミット: 2時間前

⚠️  田中さんも同じファイルを編集中です (src/auth/login.js)

? 次のアクションは？
❯ 田中さんに連絡する
  変更をコミットする
  リモートの更新を確認する
```

#### 作業完了
```bash
$ team-flow finish

📝 コミットメッセージを作成します

? コミットの種類を選択してください
❯ ✨ feat: 新機能

? 変更内容を簡潔に説明してください：
ユーザーログイン機能を実装

✅ コミット完了: feat: ユーザーログイン機能を実装
🧪 テスト実行中... ✅ 全て成功

? PRを作成しますか？ Yes

👥 推奨レビュアー: 
- 田中さん (同じ認証機能担当)  
- 山田さん (フロントエンド専門)

✅ PR作成完了: https://github.com/org/repo/pull/45
📢 チームに通知送信完了
```

## 🛡️ エラーハンドリング・安全機能

### 自動バックアップ
```javascript
// 危険な操作前のバックアップ
async function createSafetyBackup(operation) {
  const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
  const backupBranch = `backup/${operation}-${timestamp}`;
  
  await exec(`git branch ${backupBranch}`);
  console.log(`🛟 安全のためバックアップを作成: ${backupBranch}`);
}
```

### 操作確認
```javascript
// 重要な操作での確認プロンプト
const confirmDestructive = await confirm({
  message: `⚠️  この操作は元に戻せません。続行しますか？`,
  default: false
});
```

### 自動復旧
```javascript
// エラー時の自動復旧提案
catch (error) {
  console.error('❌ エラーが発生しました:', error.message);
  
  const shouldRecover = await confirm('自動復旧を試行しますか？');
  if (shouldRecover) {
    await autoRecover(error.type);
  }
}
```

## 🚀 今後の拡張計画

### フェーズ2: 高度な機能
- **AI支援**: コミットメッセージ・PRレビューコメント自動生成
- **メトリクス**: チーム生産性分析・ダッシュボード
- **統合拡張**: Jira、Linear、Asana連携

### フェーズ3: チーム管理
- **ワークフロー管理**: カスタムフロー定義・テンプレート
- **権限管理**: ロールベースアクセス制御
- **レポート**: 週次・月次活動レポート自動生成

### フェーズ4: エンタープライズ
- **シングルサインオン**: LDAP/SAML対応
- **監査ログ**: 全操作履歴・コンプライアンス対応
- **オンプレミス**: 企業内環境でのセルフホスト対応

---

この仕様書により、Git/GitHub初心者でも安心して使える、かつチーム開発に必要な全機能を備えた統合CLIツール「team-flow」の開発が可能になります。Next.js経験を活かしたNode.js開発により、実用的で学習価値の高いプロジェクトとなるでしょう。
